'use strict';

angular.module('animatesApp')
	.run(function triangle(shapeCreator, shapeSync, toolbarShapeService, shapeSyncHelper, shapeHelper, canvasService) {
		var typeId = 'Photo',
			objectNumber = 1;

		var oImg=document.createElement("img");
		oImg.setAttribute('src', 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D');

		var imagesCache = {};

		function createShape(mediaObjectGuid) {
			var element = imagesCache[mediaObjectGuid];
			if (element){
				return new shapeSyncHelper.Fabric.Image(element);
			}

			return new shapeSyncHelper.Fabric.Image(oImg);
		}

		shapeCreator.registerShape(typeId, createShape);

		function syncFromModel(viewObject, canvasPosition) {
			var model = shapeHelper.getMediaFrameFromView(viewObject);
			if (model) {
				var source = model.getProperty('source');

				var element = viewObject.getElement();
				if (source && element.src !== source) {
					var newImageElement = document.createElement("img");
					newImageElement.onload = function () {
						imagesCache[shapeHelper.getGuidFromView(viewObject)] = newImageElement;
						viewObject.setElement(newImageElement);

						shapeSyncHelper.syncVisualMediaObjectFromModel(viewObject, canvasPosition);

						shapeSyncHelper.syncViewProperty(model.getProperty('height'), viewObject, 'height');
						shapeSyncHelper.syncViewProperty(model.getProperty('width'), viewObject, 'width');
						viewObject.setCoords();
						canvasService.getInstance().renderAll();
					};
					newImageElement.setAttribute('src', source);
				} else {
					shapeSyncHelper.syncVisualMediaObjectFromModel(viewObject, canvasPosition);

					shapeSyncHelper.syncViewProperty(model.getProperty('height'), viewObject, 'height');
					shapeSyncHelper.syncViewProperty(model.getProperty('width'), viewObject, 'width');
				}
			}
		};

		function syncFromView(viewObject, canvasPosition) {
			var diff = shapeSyncHelper.syncVisualMediaObjectFromView(viewObject, canvasPosition),
				mediaObject = shapeHelper.getMediaFrameFromView(viewObject);

			shapeSyncHelper.syncModelProperty(viewObject.currentHeight || viewObject.height, mediaObject, 'height', diff, true);
			shapeSyncHelper.syncModelProperty(viewObject.currentWidth || viewObject.width, mediaObject, 'width', diff, true);

			return diff;
		};

		shapeSync.registerShape(typeId, syncFromModel, syncFromView);

		function getButtonClass() {
			return 'glyphicon glyphicon-picture';
		};

		function createMediaObject() {
			return new shapeSyncHelper.Model.Photo({
				name : typeId + ' ' + objectNumber++,
				source : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAYAAADL1t+KAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYxIDY0LjE0MDk0OSwgMjAxMC8xMi8wNy0xMDo1NzowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNS4xIE1hY2ludG9zaCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCNkRFQkQ2RDhGMEIxMUUyQTk0RERERTYwOUI3NzczMSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCNkRFQkQ2RThGMEIxMUUyQTk0RERERTYwOUI3NzczMSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkI2REVCRDZCOEYwQjExRTJBOTRERERFNjA5Qjc3NzMxIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkI2REVCRDZDOEYwQjExRTJBOTRERERFNjA5Qjc3NzMxIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+hLcQcAAAEs1JREFUeNrs3a1X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'
			});
		};

		toolbarShapeService.registerItem(typeId, getButtonClass, createMediaObject)
	});
